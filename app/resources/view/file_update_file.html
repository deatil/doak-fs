{% extends "common/base.html" %}

{% block title %}更新文件 - {{ block.Super }}{% endblock %}

{% block wrapper %}
<style>
.main-box {
    margin-bottom: 0;
    margin: 15px;
}
.main-box .main-box-body {
    padding: 20px;
}
@media screen and (max-width: 767px) {
    .table-responsive {
        margin-bottom: 0;
    }
}
</style>

<link rel="stylesheet" href='{{ assets("js/codemirror/lib/codemirror.css") }}'>
<script src='{{ assets("js/codemirror/lib/codemirror.js") }}'></script>

<link rel="stylesheet" href='{{ assets("js/codemirror/theme/material.css") }}'>
<link rel="stylesheet" href='{{ assets("js/codemirror/theme/eclipse.css") }}'>
<link rel="stylesheet" href='{{ assets("js/codemirror/theme/seti.css") }}'>
<link rel="stylesheet" href='{{ assets("js/codemirror/theme/dracula.css") }}'>

<script src='{{ assets("js/codemirror/addon/selection/active-line.js") }}'></script>

<!--支持代码折叠-->
<link rel="stylesheet" href='{{ assets("js/codemirror/addon/fold/foldgutter.css") }}'/>
<script src='{{ assets("js/codemirror/addon/fold/foldcode.js") }}'></script>
<script src='{{ assets("js/codemirror/addon/fold/foldgutter.js") }}'></script>
<script src='{{ assets("js/codemirror/addon/fold/brace-fold.js") }}'></script>
<script src='{{ assets("js/codemirror/addon/fold/comment-fold.js") }}'></script>

<!--全屏模式-->
<link rel="stylesheet" href='{{ assets("js/codemirror/addon/display/fullscreen.css") }}'>
<script src='{{ assets("js/codemirror/addon/display/fullscreen.js") }}'></script>

<!--括号匹配-->
<script src='{{ assets("js/codemirror/addon/edit/matchbrackets.js") }}'></script>

<!--自动补全-->
<link rel="stylesheet" href='{{ assets("js/codemirror/addon/hint/show-hint.css") }}'>
<script src='{{ assets("js/codemirror/addon/hint/show-hint.js") }}'></script>
<script src='{{ assets("js/codemirror/addon/hint/anyword-hint.js") }}'></script>

<!--高亮类型-->
<script src='{{ assets("js/codemirror/mode/go/go.js") }}'></script>

<script src='{{ assets("js/jquery.js") }}' type="text/javascript"></script>
<script src='{{ assets("js/layer/layer.js") }}' type="text/javascript"></script>

<div class="main-box clearfix">
    <div class="main-box-body clearfix">
        <form role="form">
            <div class="form-group">
                <label for="file-content">文件详情</label>
                <textarea class="form-control" id="file-content" rows="5">{{ data }}</textarea>
            </div>
            
            <input type="hidden" id="fs-file" value="{{ file }}" />
            <div class="form-group">
                <div class="col-lg-12">
                    <button type="button" class="btn btn-success js-save-btn">提交保存</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block script %}
<script type="text/javascript">
;(function($) {
    "use strict";
    
    // 语法高亮
    var editor = CodeMirror.fromTextArea(document.getElementById("file-content"), {
        // 显示行号
        lineNumbers: true,
        styleActiveLine: true,
        
        // 主题
        theme: "material",
        
        // 代码折叠
        lineWrapping:false,
        foldGutter: true,
        gutters:["CodeMirror-linenumbers", "CodeMirror-foldgutter"],

        // 全屏模式
        fullScreen:false,

        // 括号匹配
        matchBrackets:true,

        // ctrl-space唤起智能提示 
        extraKeys:{
            "Ctrl-Space":"autocomplete",
            "Shift-Alt-Enter": function (cm) {
                cm.setOption("fullScreen", !cm.getOption("fullScreen"));
            }
        },
        
        // 高亮
        mode: "go"
    });
    editor.on("change", function(cm) {
        $("#file-content").val(cm.getValue())
    });
    
    // 保存
    $(".js-save-btn").click(function(e) {
        e.stopPropagation;
        e.preventDefault;

        var file = $("#fs-file").val();
        var data = $("#file-content").val();

        var url = '/file/update-file';
        $.post(url, {
            file: file,
            data: data,
        }, function(data) {
            if (data.code == 0) {
                layer.msg("保存成功");
                
                setTimeout(function() {
                    window.location.reload();
                }, 1500);
            } else {
                layer.msg(data.message);
            }
        }).fail(function (xhr, status, info) {
            layer.msg("请求失败");
        });
    });
})(jQuery);
</script>
{% endblock %}